<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="initial-scale=1.0">
   <link rel="stylesheet" href="style.css">
   <script src="./build/aya.js"></script>
   <title>ayajs</title>
</head>

<body>

   <script>
    var aya = new aya.Application();
    console.log(aya);

    var arrow = aya.Line(200,100,400-50 - 10,100);
    arrow.draw();
    arrow.children.map( ({child, translate, rotate}, index) => {
        child.c_svg.setAttribute("fill", "black");
    });

    var res = aya.Component("ressource", {x:400, y: 100, r: 50, nb_method: 4});
    res.form.removeBoxFromDOM();

    var cpt = 0;
    var state = null;
    var isDown = false;
    res.form.addEvent("mouseover", ()=>{
        cpt++;
        if(cpt == 1 && state == null){
            state = "over";
        res.form.verb.map( ({arc, line1, line2, text}) => {
            arc.draw();
            line1.draw();
            line2.draw();
            text.draw();
        });
        }
    });
    res.form.addEvent("mouseleave", ()=>{
        res.form.verb.map( ({arc, line1, line2, text}, index) => {
            setTimeout(() => {
                arc.removeFromDOM()
                line1.removeFromDOM();
                line2.removeFromDOM();
                text.removeFromDOM();
                cpt = 0;
            }, (10000));
        });
    });

     setTimeout(() => {
      if(state == "over"){
         res.form.verb.map(  ({arc, line1, line2, text}, index) =>{
                console.log("ready");
                    arc.addEvent("mousedown", () => {
                        var pt;
                        res.form.method = [];
                        arc.removeFromDOM();
                        line1.removeFromDOM();
                        line2.removeFromDOM();
                        text.c_svg.setAttribute("fill", "blue");
                        if(index == 1 || index == 2 || index == 3)
                            pt = [line2.dest_x, line2.dest_y, line2.x, line2.y];
                        else
                            pt = [line1.x, line1.y, line1.dest_x, line1.dest_y];
                        res.form.method[index] = {text : text, point: pt};
                        res.form.verb.splice( index, 1);
                        Object.keys(res.form.method).map((idx) => {
                            var alias = res.form.method[idx].point;
                            if(idx == 0){
                                console.log("0");
                                var pat = aya.Polyline([ alias[0] - 50, alias[1], ...alias]);
                                var box = aya.Rectangle(pat.x - 50, pat.y - 10, 50, 20);
                                box.draw();
                                pat.draw();
                                res.form.method[idx].text.removeFromDOM();
                                res.form.method[idx].text.setRotateAngle(0);
                                res.form.method[idx].text.setRotateCenter(0,0);
                                res.form.method[idx].text.x = pat.x + 10;
                                res.form.method[idx].text.y = pat.y - 5;
                                res.form.method[idx].text.draw();
                                pat.c_svg.setAttribute("fill", "none");
                            }
                            else if(idx == 1){
                                console.log("1");
                                var pat = aya.Polyline([res.form.method[idx].point, ...[alias[alias.length - 2] + 60, alias[alias.length - 1]]]);
                                var box = aya.Rectangle(pat.dest_x + 1, pat.dest_y - 10, 50, 20);
                                box.draw();
                                pat.draw();
                                res.form.method[idx].text.removeFromDOM();
                                res.form.method[idx].text.setRotateAngle(0);
                                res.form.method[idx].text.setRotateCenter(0,0);
                                res.form.method[idx].text.x = alias[2] + 15;
                                res.form.method[idx].text.y = alias[3] - 5;
                                res.form.method[idx].text.draw();
                                pat.c_svg.setAttribute("fill", "none");
                            }
                            else if(idx == 2){
                                console.log("2");
                                var pat = aya.Polyline([res.form.method[idx].point, ...[alias[alias.length - 2] + 30, alias[alias.length - 1]]]);
                                var box = aya.Rectangle(pat.dest_x + 2, pat.dest_y - 10, 50, 20);
                                box.draw();
                                pat.draw();
                                res.form.method[idx].text.removeFromDOM();
                                res.form.method[idx].text.setRotateAngle(0);
                                res.form.method[idx].text.setRotateCenter(0,0);
                                res.form.method[idx].text.x = alias[2];
                                res.form.method[idx].text.y = alias[3] - 5;
                                res.form.method[idx].text.draw();
                                pat.c_svg.setAttribute("fill", "none");
                            }
                            else{
                                console.log("3");
                                var pat = aya.Polyline([res.form.method[idx].point, ...[alias[alias.length - 2] + 35, alias[alias.length - 1]]]);
                                var box = aya.Rectangle(pat.dest_x, pat.dest_y - 10, 50, 20);
                                box.draw();
                                pat.draw();
                                res.form.method[idx].text.removeFromDOM();
                                res.form.method[idx].text.setRotateAngle(0);
                                res.form.method[idx].text.setRotateCenter(0,0);
                                res.form.method[idx].text.x = alias[2];
                                res.form.method[idx].text.y = alias[3] - 5;
                                res.form.method[idx].text.draw();
                                pat.c_svg.setAttribute("fill", "none");
                            }
                        });
                    });
            });
         state = null;
      }
     }, 500);

      document.body.append(aya.svg);
   </script>

</body>
</html>